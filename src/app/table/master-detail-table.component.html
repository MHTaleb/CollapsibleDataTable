<mat-table
[dataSource]="dataSignal().rows"
class="mat-elevation-z8"
multiTemplateDataRows
>
<!-- Dynamically define each visible column -->
<ng-container *ngFor="let header of dataSignal().headers" [matColumnDef]="header.id">
  @if (header.visible) {
    <mat-header-cell *matHeaderCellDef>
      {{ header.name }}
    </mat-header-cell>
    <mat-cell *matCellDef="let row">
      {{ row.data[header.id] }}
    </mat-cell>
  }
</ng-container>

<!-- Expansion Detail Column Definition -->
<ng-container matColumnDef="expandedDetail">
  <mat-cell *matCellDef="let row" [attr.colspan]="displayedColumns().length">
    @if (row.detailData) {
      <mat-expansion-panel
        [expanded]="expandedRow() === row"
        (opened)="expandedRow.set(row)"
        (closed)="expandedRow.set(null)"
      >
        <mat-expansion-panel-header>
          <mat-panel-title>
            Details for {{ row.data[displayedColumns()[0]] }}
          </mat-panel-title>
        </mat-expansion-panel-header>

        <!-- If detail headers differ, render a nested table -->
        @if (!areHeadersEqual(dataSignal().headers, row.detailData.headers)) {
          <app-master-detail-table
            [dataSignal]="createSignal(row.detailData)"
          ></app-master-detail-table>
        } @else {
          <!-- Otherwise, render "inline" details -->
          <div *ngFor="let detailRow of row.detailData.rows" class="inline-detail">
            <ng-container *ngFor="let header of dataSignal().headers">
              @if (header.visible) {
                <span class="detail-cell">{{ detailRow.data[header.id] }}</span>
              }
            </ng-container>
          </div>
        }
      </mat-expansion-panel>
    }
  </mat-cell>
</ng-container>

<!-- Header Row -->
<mat-header-row *matHeaderRowDef="displayedColumns()"></mat-header-row>

<!-- Main Row: displays columns -->
<mat-row
  *matRowDef="let row; columns: displayedColumns()"
  (click)="toggleExpand(row)"
  class="data-row"
></mat-row>

<!-- Detail Row: uses the single column 'expandedDetail' -->
<mat-row
  *matRowDef="let row; columns: ['expandedDetail']; when: isExpansionDetailRow"
  class="detail-row"
></mat-row>
</mat-table>