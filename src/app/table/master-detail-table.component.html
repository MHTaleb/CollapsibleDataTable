<!-- MASTER TABLE -->
<mat-table [dataSource]="dataSignal().rows" class="mat-elevation-z8">
  <!-- Dynamically create columns based on visible headers -->
  <ng-container
    *ngFor="let header of dataSignal().headers"
    [matColumnDef]="header.id"
  >
    @if(header.visible) {
    <mat-header-cell *matHeaderCellDef> {{ header.name }} </mat-header-cell>
    <mat-cell *matCellDef="let row"> {{ row.data[header.id] }} </mat-cell>
    }>
  </ng-container>

  <mat-header-row *matHeaderRowDef="displayedColumns()"></mat-header-row>
  <mat-row
    *matRowDef="let row; columns: displayedColumns()"
    (click)="onRowClick(row)"
  ></mat-row>
</mat-table>

<!-- DETAIL ROWS (using expansion panels for rows that have detailData) -->
<ng-container *ngFor="let row of dataSignal().rows">
  @if (row.detailData) {
  <mat-expansion-panel>
    <mat-expansion-panel-header>
      <mat-panel-title>
        Details for {{ row.data[displayedColumns()[0]] }}
      </mat-panel-title>
    </mat-expansion-panel-header>

    <!-- If detail headers differ, render a nested MasterDetailTable -->
    @if (!areHeadersEqual(dataSignal().headers, row.detailData.headers)) {
    <app-master-detail-table
      [dataSignal]="createSignal(row.detailData)"
    ></app-master-detail-table>
    } @else {
    <!-- Otherwise, render inline detail rows -->
    <div *ngFor="let detailRow of row.detailData.rows" class="detail-row">
      <ng-container *ngFor="let header of dataSignal().headers">
        @if(header.visible) {
        <span class="detail-cell">{{ detailRow.data[header.id] }}</span>
        }>
      </ng-container>
    </div>
    }
  </mat-expansion-panel>
  }
</ng-container>
